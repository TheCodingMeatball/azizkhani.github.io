---
layout: post
title: "Simple Cross Site Scripting (XSS) Servlet Filter"
comments: true
---
<p>Ran into some issues on some of our Java sites today and needed a quick fix to protect the sites from malicious <a href="http://en.wikipedia.org/wiki/Cross_site_scripting">Cross Site Scripting (XSS)</a> attempts. If you're not aware of what XSS is and have websites that have sensitive user data, you may want to read up, you're probably vulnerable, which means your users are vulnerable. I'm not claiming this is a perfect solution, but it was easy to implement and corrected the vulnerabilities with form and url injection. We basically have a Servlet Filter that's going to intercept every request sent to the web application and then we use an HttpServletRequestWrapper to wrap and override the getParameter methods and clean any potential script injection.</p>
<p><br /> Here's the Filter:</p>
<div>
<div id="highlighter_728605" class="syntaxhighlighter  java"><span style="font-size: x-small;"><strong>package com.greatwebguy.filter;</strong></span><br /><span style="font-size: x-small;"><strong>import java.io.IOException;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.Filter;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.FilterChain;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.FilterConfig;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.ServletException;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.ServletRequest;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.ServletResponse;</strong></span><br /><span style="font-size: x-small;"><strong>import javax.servlet.http.HttpServletRequest;</strong></span><br /><span style="font-size: x-small;"><strong>public class CrossScriptingFilter implements Filter {</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; public void init(FilterConfig filterConfig) throws ServletException {</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.filterConfig = filterConfig;</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; }</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; public void destroy() {</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.filterConfig = null;</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; }</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws IOException, ServletException {</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chain.doFilter(new RequestWrapper((HttpServletRequest) request), response);</strong></span><br /><span style="font-size: x-small;"><strong>&nbsp;&nbsp;&nbsp; }</strong></span><br /><span style="font-size: x-small;"><strong>}</strong></span><br class="toolbar_item command_help help" />
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">&nbsp;</td>
<td class="code">&nbsp;</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here's the wrapper:</p>
<p>&nbsp;</p>
<div class="container">
<div class="line number1 index0 alt2"><strong><span style="font-size: small;"><code class="java keyword">package</code> <code class="java plain">com.greatwebguy.filter;</code></span></strong></div>
<div class="line number2 index1 alt1"><strong><span style="font-size: small;"><code class="java keyword">import</code> <code class="java plain">javax.servlet.http.HttpServletRequest;</code></span></strong></div>
<div class="line number3 index2 alt2"><strong><span style="font-size: small;"><code class="java keyword">import</code> <code class="java plain">javax.servlet.http.HttpServletRequestWrapper;</code></span></strong></div>
<div class="line number4 index3 alt1"><strong><span style="font-size: small;"><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">RequestWrapper </code><code class="java keyword">extends</code> <code class="java plain">HttpServletRequestWrapper {</code></span></strong></div>
<div class="line number5 index4 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">RequestWrapper(HttpServletRequest servletRequest) {</code></span></strong></div>
<div class="line number6 index5 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">super</code><code class="java plain">(servletRequest);</code></span></strong></div>
<div class="line number7 index6 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number8 index7 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String[] getParameterValues(String parameter) {</code></span></strong></div>
<div class="line number9 index8 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">String[] values = </code><code class="java keyword">super</code><code class="java plain">.getParameterValues(parameter);</code></span></strong></div>
<div class="line number10 index9 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(values==</code><code class="java keyword">null</code><code class="java plain">)&nbsp; {</code></span></strong></div>
<div class="line number11 index10 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></span></strong></div>
<div class="line number12 index11 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number13 index12 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">count = values.length;</code></span></strong></div>
<div class="line number14 index13 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">String[] encodedValues = </code><code class="java keyword">new</code> <code class="java plain">String[count];</code></span></strong></div>
<div class="line number15 index14 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code><code class="java plain">; i &lt; count; i++) {</code></span></strong></div>
<div class="line number16 index15 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">encodedValues[i] = cleanXSS(values[i]);</code></span></strong></div>
<div class="line number17 index16 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number18 index17 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">encodedValues;</code></span></strong></div>
<div class="line number19 index18 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number20 index19 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String getParameter(String parameter) {</code></span></strong></div>
<div class="line number21 index20 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">String value = </code><code class="java keyword">super</code><code class="java plain">.getParameter(parameter);</code></span></strong></div>
<div class="line number22 index21 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">) {</code></span></strong></div>
<div class="line number23 index22 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></span></strong></div>
<div class="line number24 index23 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number25 index24 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">cleanXSS(value);</code></span></strong></div>
<div class="line number26 index25 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number27 index26 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String getHeader(String name) {</code></span></strong></div>
<div class="line number28 index27 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">String value = </code><code class="java keyword">super</code><code class="java plain">.getHeader(name);</code></span></strong></div>
<div class="line number29 index28 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">)</code></span></strong></div>
<div class="line number30 index29 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></span></strong></div>
<div class="line number31 index30 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">cleanXSS(value);</code></span></strong></div>
<div class="line number32 index31 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number33 index32 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">String cleanXSS(String value) {</code></span></strong></div>
<div class="line number34 index33 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">//You'll need to remove the spaces from the html entities below</code></span></strong></div>
<div class="line number35 index34 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"&lt;"</code><code class="java plain">, </code><code class="java string">"&amp; lt;"</code><code class="java plain">).replaceAll(</code><code class="java string">"&gt;"</code><code class="java plain">, </code><code class="java string">"&amp; gt;"</code><code class="java plain">);</code></span></strong></div>
<div class="line number36 index35 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"\\("</code><code class="java plain">, </code><code class="java string">"&amp; #40;"</code><code class="java plain">).replaceAll(</code><code class="java string">"\\)"</code><code class="java plain">, </code><code class="java string">"&amp; #41;"</code><code class="java plain">);</code></span></strong></div>
<div class="line number37 index36 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"'"</code><code class="java plain">, </code><code class="java string">"&amp; #39;"</code><code class="java plain">);</code></span></strong></div>
<div class="line number38 index37 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"eval\\((.*)\\)"</code><code class="java plain">, </code><code class="java string">""</code><code class="java plain">);</code></span></strong></div>
<div class="line number39 index38 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"[\\\"\\\'][\\s]*javascript:(.*)[\\\"\\\']"</code><code class="java plain">, </code><code class="java string">"\"\""</code><code class="java plain">);</code></span></strong></div>
<div class="line number40 index39 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">value = value.replaceAll(</code><code class="java string">"script"</code><code class="java plain">, </code><code class="java string">""</code><code class="java plain">);</code></span></strong></div>
<div class="line number41 index40 alt2"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">value;</code></span></strong></div>
<div class="line number42 index41 alt1"><strong><span style="font-size: small;"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></span></strong></div>
<div class="line number43 index42 alt2"><strong><span style="font-size: small;"><code class="java plain">}</code></span></strong></div>
</div>
<p>&nbsp;</p>
<p>Add this to the top of your web.xml:</p>
<div>
<div id="highlighter_794872" class="syntaxhighlighter  xml">
<div class="toolbar"><span><a class="toolbar_item command_help help" href="http://greatwebguy.com/programming/java/simple-cross-site-scripting-xss-servlet-filter/#">?</a></span></div>
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><strong><span style="font-size: small;"><code class="xml plain">&lt;</code><code class="xml keyword">filter</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number2 index1 alt1"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">filter-name</code><code class="xml plain">&gt;XSS&lt;/</code><code class="xml keyword">filter-name</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number3 index2 alt2"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">display-name</code><code class="xml plain">&gt;XSS&lt;/</code><code class="xml keyword">display-name</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number4 index3 alt1"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">description</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">description</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number5 index4 alt2"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">filter-class</code><code class="xml plain">&gt;com.greatwebguy.filter.CrossScriptingFilter&lt;/</code><code class="xml keyword">filter-class</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number6 index5 alt1"><strong><span style="font-size: small;"><code class="xml plain">&lt;/</code><code class="xml keyword">filter</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number7 index6 alt2"><strong><span style="font-size: small;"><code class="xml plain">&lt;</code><code class="xml keyword">filter-mapping</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number8 index7 alt1"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">filter-name</code><code class="xml plain">&gt;XSS&lt;/</code><code class="xml keyword">filter-name</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number9 index8 alt2"><strong><span style="font-size: small;"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">url-pattern</code><code class="xml plain">&gt;/*&lt;/</code><code class="xml keyword">url-pattern</code><code class="xml plain">&gt;</code></span></strong></div>
<div class="line number10 index9 alt1"><strong><span style="font-size: small;"><code class="xml plain">&lt;/</code><code class="xml keyword">filter-mapping</code><code class="xml plain">&gt;</code></span></strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>I'm sure the cleanXSS replacements aren't the most efficient way of doing this, you could replace it StringEscapeUtils.escapeHtml from commons lang to simplify it a little, it's up to you, it all depends on what your site is doing and whether it's going to be a pain having all the html escaped, you could also adjust the url-pattern of the filter to be more specific to your application urls, so that everything under your app isn't running through the filter.</p>
<p>Some things to be aware of with this approach, you'll need to account for what you've encoded or in some cases you'll end up with weird characters in your database and possibly in validation of your input boxes. Some would recommend a more positive validation rather than negative validation and only allow a certain range of characters, it's up to you, but it is something to think about.</p>
<p>&nbsp;</p>
<p>refrence:http://greatwebguy.com/programming/java/simple-cross-site-scripting-xss-servlet-filter/</p>
